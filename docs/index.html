<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 0.36.1">
<meta name="crystal_docs.project_version" content="master-dev">
<meta name="crystal_docs.project_name" content="cryomongo">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="cryomongo">
  <title>cryomongo master-dev</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          cryomongo
        </a>
      </h1>

      <span class="project-version">
        master-dev
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="cryomongo/Mongo" data-name="mongo">
      <a href="Mongo.html">Mongo</a>
      
        <ul>
  
  <li class="parent " data-id="cryomongo/Mongo/Bulk" data-name="mongo::bulk">
      <a href="Mongo/Bulk.html">Bulk</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/DeleteMany" data-name="mongo::bulk::deletemany">
      <a href="Mongo/Bulk/DeleteMany.html">DeleteMany</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/DeleteOne" data-name="mongo::bulk::deleteone">
      <a href="Mongo/Bulk/DeleteOne.html">DeleteOne</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/Error" data-name="mongo::bulk::error">
      <a href="Mongo/Bulk/Error.html">Error</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/InsertOne" data-name="mongo::bulk::insertone">
      <a href="Mongo/Bulk/InsertOne.html">InsertOne</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/ReplaceOne" data-name="mongo::bulk::replaceone">
      <a href="Mongo/Bulk/ReplaceOne.html">ReplaceOne</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/UpdateMany" data-name="mongo::bulk::updatemany">
      <a href="Mongo/Bulk/UpdateMany.html">UpdateMany</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/UpdateOne" data-name="mongo::bulk::updateone">
      <a href="Mongo/Bulk/UpdateOne.html">UpdateOne</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/WriteModel" data-name="mongo::bulk::writemodel">
      <a href="Mongo/Bulk/WriteModel.html">WriteModel</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Bulk/WriteResult" data-name="mongo::bulk::writeresult">
      <a href="Mongo/Bulk/WriteResult.html">WriteResult</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/ChangeStream" data-name="mongo::changestream">
      <a href="Mongo/ChangeStream.html">ChangeStream</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/ChangeStream/Cursor" data-name="mongo::changestream::cursor">
      <a href="Mongo/ChangeStream/Cursor.html">Cursor</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/ChangeStream/Document" data-name="mongo::changestream::document(t)">
      <a href="Mongo/ChangeStream/Document.html">Document</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/ChangeStream/Document/UpdateDescription" data-name="mongo::changestream::document::updatedescription">
      <a href="Mongo/ChangeStream/Document/UpdateDescription.html">UpdateDescription</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Client" data-name="mongo::client">
      <a href="Mongo/Client.html">Client</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Client/NetworkError" data-name="mongo::client::networkerror">
      <a href="Mongo/Client/NetworkError.html">NetworkError</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Collation" data-name="mongo::collation">
      <a href="Mongo/Collation.html">Collation</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Collection" data-name="mongo::collection">
      <a href="Mongo/Collection.html">Collection</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Collection/CollectionKey" data-name="mongo::collection::collectionkey">
      <a href="Mongo/Collection/CollectionKey.html">CollectionKey</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands" data-name="mongo::commands">
      <a href="Mongo/Commands.html">Commands</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/AbortTransaction" data-name="mongo::commands::aborttransaction">
      <a href="Mongo/Commands/AbortTransaction.html">AbortTransaction</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Aggregate" data-name="mongo::commands::aggregate">
      <a href="Mongo/Commands/Aggregate.html">Aggregate</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/AlwaysRetryable" data-name="mongo::commands::alwaysretryable">
      <a href="Mongo/Commands/AlwaysRetryable.html">AlwaysRetryable</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/BuildInfo" data-name="mongo::commands::buildinfo">
      <a href="Mongo/Commands/BuildInfo.html">BuildInfo</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/BuildInfo/Result" data-name="mongo::commands::buildinfo::result">
      <a href="Mongo/Commands/BuildInfo/Result.html">Result</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/CloneCollectionAsCapped" data-name="mongo::commands::clonecollectionascapped">
      <a href="Mongo/Commands/CloneCollectionAsCapped.html">CloneCollectionAsCapped</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/CollMod" data-name="mongo::commands::collmod">
      <a href="Mongo/Commands/CollMod.html">CollMod</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/CollStats" data-name="mongo::commands::collstats">
      <a href="Mongo/Commands/CollStats.html">CollStats</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Command" data-name="mongo::commands::command">
      <a href="Mongo/Commands/Command.html">Command</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/CommitTransaction" data-name="mongo::commands::committransaction">
      <a href="Mongo/Commands/CommitTransaction.html">CommitTransaction</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/Common" data-name="mongo::commands::common">
      <a href="Mongo/Commands/Common.html">Common</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/BaseResult" data-name="mongo::commands::common::baseresult">
      <a href="Mongo/Commands/Common/BaseResult.html">BaseResult</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/Cursor" data-name="mongo::commands::common::cursor">
      <a href="Mongo/Commands/Common/Cursor.html">Cursor</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/DeleteResult" data-name="mongo::commands::common::deleteresult">
      <a href="Mongo/Commands/Common/DeleteResult.html">DeleteResult</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/FindAndModifyResult" data-name="mongo::commands::common::findandmodifyresult">
      <a href="Mongo/Commands/Common/FindAndModifyResult.html">FindAndModifyResult</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/InsertResult" data-name="mongo::commands::common::insertresult">
      <a href="Mongo/Commands/Common/InsertResult.html">InsertResult</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/QueryResult" data-name="mongo::commands::common::queryresult">
      <a href="Mongo/Commands/Common/QueryResult.html">QueryResult</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/UpdateResult" data-name="mongo::commands::common::updateresult">
      <a href="Mongo/Commands/Common/UpdateResult.html">UpdateResult</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/Upserted" data-name="mongo::commands::common::upserted">
      <a href="Mongo/Commands/Common/Upserted.html">Upserted</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/WriteConcernError" data-name="mongo::commands::common::writeconcernerror">
      <a href="Mongo/Commands/Common/WriteConcernError.html">WriteConcernError</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Common/WriteError" data-name="mongo::commands::common::writeerror">
      <a href="Mongo/Commands/Common/WriteError.html">WriteError</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Compact" data-name="mongo::commands::compact">
      <a href="Mongo/Commands/Compact.html">Compact</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ConfigureFailPoint" data-name="mongo::commands::configurefailpoint">
      <a href="Mongo/Commands/ConfigureFailPoint.html">ConfigureFailPoint</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ConnectionStatus" data-name="mongo::commands::connectionstatus">
      <a href="Mongo/Commands/ConnectionStatus.html">ConnectionStatus</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ConnPoolStats" data-name="mongo::commands::connpoolstats">
      <a href="Mongo/Commands/ConnPoolStats.html">ConnPoolStats</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ConvertToCapped" data-name="mongo::commands::converttocapped">
      <a href="Mongo/Commands/ConvertToCapped.html">ConvertToCapped</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Count" data-name="mongo::commands::count">
      <a href="Mongo/Commands/Count.html">Count</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Create" data-name="mongo::commands::create">
      <a href="Mongo/Commands/Create.html">Create</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/CreateIndexes" data-name="mongo::commands::createindexes">
      <a href="Mongo/Commands/CreateIndexes.html">CreateIndexes</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/CreateIndexes/Result" data-name="mongo::commands::createindexes::result">
      <a href="Mongo/Commands/CreateIndexes/Result.html">Result</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/CurrentOp" data-name="mongo::commands::currentop">
      <a href="Mongo/Commands/CurrentOp.html">CurrentOp</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/DataSize" data-name="mongo::commands::datasize">
      <a href="Mongo/Commands/DataSize.html">DataSize</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/DbHash" data-name="mongo::commands::dbhash">
      <a href="Mongo/Commands/DbHash.html">DbHash</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/DbStats" data-name="mongo::commands::dbstats">
      <a href="Mongo/Commands/DbStats.html">DbStats</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Delete" data-name="mongo::commands::delete">
      <a href="Mongo/Commands/Delete.html">Delete</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/Distinct" data-name="mongo::commands::distinct">
      <a href="Mongo/Commands/Distinct.html">Distinct</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Distinct/Result" data-name="mongo::commands::distinct::result">
      <a href="Mongo/Commands/Distinct/Result.html">Result</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Drop" data-name="mongo::commands::drop">
      <a href="Mongo/Commands/Drop.html">Drop</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/DropConnections" data-name="mongo::commands::dropconnections">
      <a href="Mongo/Commands/DropConnections.html">DropConnections</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/DropDatabase" data-name="mongo::commands::dropdatabase">
      <a href="Mongo/Commands/DropDatabase.html">DropDatabase</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/DropIndexes" data-name="mongo::commands::dropindexes">
      <a href="Mongo/Commands/DropIndexes.html">DropIndexes</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/EndSessions" data-name="mongo::commands::endsessions">
      <a href="Mongo/Commands/EndSessions.html">EndSessions</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Explain" data-name="mongo::commands::explain">
      <a href="Mongo/Commands/Explain.html">Explain</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Find" data-name="mongo::commands::find">
      <a href="Mongo/Commands/Find.html">Find</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/FindAndModify" data-name="mongo::commands::findandmodify">
      <a href="Mongo/Commands/FindAndModify.html">FindAndModify</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Fsync" data-name="mongo::commands::fsync">
      <a href="Mongo/Commands/Fsync.html">Fsync</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/FsyncUnlock" data-name="mongo::commands::fsyncunlock">
      <a href="Mongo/Commands/FsyncUnlock.html">FsyncUnlock</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/FsyncUnlock/Result" data-name="mongo::commands::fsyncunlock::result">
      <a href="Mongo/Commands/FsyncUnlock/Result.html">Result</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/GetCmdLineOpts" data-name="mongo::commands::getcmdlineopts">
      <a href="Mongo/Commands/GetCmdLineOpts.html">GetCmdLineOpts</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/GetLog" data-name="mongo::commands::getlog">
      <a href="Mongo/Commands/GetLog.html">GetLog</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/GetMore" data-name="mongo::commands::getmore">
      <a href="Mongo/Commands/GetMore.html">GetMore</a>
      
        <ul>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/GetMore/Result" data-name="mongo::commands::getmore::result">
      <a href="Mongo/Commands/GetMore/Result.html">Result</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/GetMore/Result/Cursor" data-name="mongo::commands::getmore::result::cursor">
      <a href="Mongo/Commands/GetMore/Result/Cursor.html">Cursor</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/GetParameter" data-name="mongo::commands::getparameter">
      <a href="Mongo/Commands/GetParameter.html">GetParameter</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/GetParameter/Result" data-name="mongo::commands::getparameter::result">
      <a href="Mongo/Commands/GetParameter/Result.html">Result</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/HostInfo" data-name="mongo::commands::hostinfo">
      <a href="Mongo/Commands/HostInfo.html">HostInfo</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Insert" data-name="mongo::commands::insert">
      <a href="Mongo/Commands/Insert.html">Insert</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/IsMaster" data-name="mongo::commands::ismaster">
      <a href="Mongo/Commands/IsMaster.html">IsMaster</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/IsMaster/Result" data-name="mongo::commands::ismaster::result">
      <a href="Mongo/Commands/IsMaster/Result.html">Result</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/KillAllSessions" data-name="mongo::commands::killallsessions">
      <a href="Mongo/Commands/KillAllSessions.html">KillAllSessions</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/KillAllSessionsByPattern" data-name="mongo::commands::killallsessionsbypattern">
      <a href="Mongo/Commands/KillAllSessionsByPattern.html">KillAllSessionsByPattern</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/KillCursors" data-name="mongo::commands::killcursors">
      <a href="Mongo/Commands/KillCursors.html">KillCursors</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/KillCursors/Result" data-name="mongo::commands::killcursors::result">
      <a href="Mongo/Commands/KillCursors/Result.html">Result</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/KillOp" data-name="mongo::commands::killop">
      <a href="Mongo/Commands/KillOp.html">KillOp</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/KillSessions" data-name="mongo::commands::killsessions">
      <a href="Mongo/Commands/KillSessions.html">KillSessions</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ListCollections" data-name="mongo::commands::listcollections">
      <a href="Mongo/Commands/ListCollections.html">ListCollections</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ListCommands" data-name="mongo::commands::listcommands">
      <a href="Mongo/Commands/ListCommands.html">ListCommands</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/ListDatabases" data-name="mongo::commands::listdatabases">
      <a href="Mongo/Commands/ListDatabases.html">ListDatabases</a>
      
        <ul>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/ListDatabases/Result" data-name="mongo::commands::listdatabases::result">
      <a href="Mongo/Commands/ListDatabases/Result.html">Result</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ListDatabases/Result/Database" data-name="mongo::commands::listdatabases::result::database">
      <a href="Mongo/Commands/ListDatabases/Result/Database.html">Database</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ListIndexes" data-name="mongo::commands::listindexes">
      <a href="Mongo/Commands/ListIndexes.html">ListIndexes</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/LogRotate" data-name="mongo::commands::logrotate">
      <a href="Mongo/Commands/LogRotate.html">LogRotate</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/MayUseSecondary" data-name="mongo::commands::mayusesecondary">
      <a href="Mongo/Commands/MayUseSecondary.html">MayUseSecondary</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Ping" data-name="mongo::commands::ping">
      <a href="Mongo/Commands/Ping.html">Ping</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Profile" data-name="mongo::commands::profile">
      <a href="Mongo/Commands/Profile.html">Profile</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ReadCommand" data-name="mongo::commands::readcommand">
      <a href="Mongo/Commands/ReadCommand.html">ReadCommand</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/RefreshSessions" data-name="mongo::commands::refreshsessions">
      <a href="Mongo/Commands/RefreshSessions.html">RefreshSessions</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ReIndex" data-name="mongo::commands::reindex">
      <a href="Mongo/Commands/ReIndex.html">ReIndex</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/RenameCollection" data-name="mongo::commands::renamecollection">
      <a href="Mongo/Commands/RenameCollection.html">RenameCollection</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Retryable" data-name="mongo::commands::retryable">
      <a href="Mongo/Commands/Retryable.html">Retryable</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ServerStatus" data-name="mongo::commands::serverstatus">
      <a href="Mongo/Commands/ServerStatus.html">ServerStatus</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/SetFeatureCompatibilityVersion" data-name="mongo::commands::setfeaturecompatibilityversion">
      <a href="Mongo/Commands/SetFeatureCompatibilityVersion.html">SetFeatureCompatibilityVersion</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/SetParameter" data-name="mongo::commands::setparameter">
      <a href="Mongo/Commands/SetParameter.html">SetParameter</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/ShardConnPoolStats" data-name="mongo::commands::shardconnpoolstats">
      <a href="Mongo/Commands/ShardConnPoolStats.html">ShardConnPoolStats</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Shutdown" data-name="mongo::commands::shutdown">
      <a href="Mongo/Commands/Shutdown.html">Shutdown</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/StartSession" data-name="mongo::commands::startsession">
      <a href="Mongo/Commands/StartSession.html">StartSession</a>
      
        <ul>
  
  <li class="parent " data-id="cryomongo/Mongo/Commands/StartSession/Result" data-name="mongo::commands::startsession::result">
      <a href="Mongo/Commands/StartSession/Result.html">Result</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/StartSession/Result/ID" data-name="mongo::commands::startsession::result::id">
      <a href="Mongo/Commands/StartSession/Result/ID.html">ID</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Top" data-name="mongo::commands::top">
      <a href="Mongo/Commands/Top.html">Top</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Update" data-name="mongo::commands::update">
      <a href="Mongo/Commands/Update.html">Update</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/Validate" data-name="mongo::commands::validate">
      <a href="Mongo/Commands/Validate.html">Validate</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Commands/WriteCommand" data-name="mongo::commands::writecommand">
      <a href="Mongo/Commands/WriteCommand.html">WriteCommand</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Cursor" data-name="mongo::cursor">
      <a href="Mongo/Cursor.html">Cursor</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Cursor/Wrapper" data-name="mongo::cursor::wrapper(t)">
      <a href="Mongo/Cursor/Wrapper.html">Wrapper</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Database" data-name="mongo::database">
      <a href="Mongo/Database.html">Database</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Error" data-name="mongo::error">
      <a href="Mongo/Error.html">Error</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Error/Client" data-name="mongo::error::client">
      <a href="Mongo/Error/Client.html">Client</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Error/Command" data-name="mongo::error::command">
      <a href="Mongo/Error/Command.html">Command</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Error/CommandWrite" data-name="mongo::error::commandwrite">
      <a href="Mongo/Error/CommandWrite.html">CommandWrite</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Error/Network" data-name="mongo::error::network">
      <a href="Mongo/Error/Network.html">Network</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Error/Server" data-name="mongo::error::server">
      <a href="Mongo/Error/Server.html">Server</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Error/ServerSelection" data-name="mongo::error::serverselection">
      <a href="Mongo/Error/ServerSelection.html">ServerSelection</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Error/Transaction" data-name="mongo::error::transaction">
      <a href="Mongo/Error/Transaction.html">Transaction</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Error/WriteConcern" data-name="mongo::error::writeconcern">
      <a href="Mongo/Error/WriteConcern.html">WriteConcern</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/GridFS" data-name="mongo::gridfs">
      <a href="Mongo/GridFS.html">GridFS</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/GridFS/Bucket" data-name="mongo::gridfs::bucket">
      <a href="Mongo/GridFS/Bucket.html">Bucket</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/GridFS/File" data-name="mongo::gridfs::file(fileid)">
      <a href="Mongo/GridFS/File.html">File</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Monitoring" data-name="mongo::monitoring">
      <a href="Mongo/Monitoring.html">Monitoring</a>
      
        <ul>
  
  <li class="parent " data-id="cryomongo/Mongo/Monitoring/Commands" data-name="mongo::monitoring::commands">
      <a href="Mongo/Monitoring/Commands.html">Commands</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Monitoring/Commands/CommandFailedEvent" data-name="mongo::monitoring::commands::commandfailedevent">
      <a href="Mongo/Monitoring/Commands/CommandFailedEvent.html">CommandFailedEvent</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Monitoring/Commands/CommandStartedEvent" data-name="mongo::monitoring::commands::commandstartedevent">
      <a href="Mongo/Monitoring/Commands/CommandStartedEvent.html">CommandStartedEvent</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Monitoring/Commands/CommandSucceededEvent" data-name="mongo::monitoring::commands::commandsucceededevent">
      <a href="Mongo/Monitoring/Commands/CommandSucceededEvent.html">CommandSucceededEvent</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Monitoring/Commands/Event" data-name="mongo::monitoring::commands::event">
      <a href="Mongo/Monitoring/Commands/Event.html">Event</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Monitoring/Observable" data-name="mongo::monitoring::observable(t)">
      <a href="Mongo/Monitoring/Observable.html">Observable</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Monitoring/Type" data-name="mongo::monitoring::type">
      <a href="Mongo/Monitoring/Type.html">Type</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Options" data-name="mongo::options">
      <a href="Mongo/Options.html">Options</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/ReadConcern" data-name="mongo::readconcern">
      <a href="Mongo/ReadConcern.html">ReadConcern</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/ReadPreference" data-name="mongo::readpreference">
      <a href="Mongo/ReadPreference.html">ReadPreference</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Session" data-name="mongo::session">
      <a href="Mongo/Session.html">Session</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Session/ClientSession" data-name="mongo::session::clientsession">
      <a href="Mongo/Session/ClientSession.html">ClientSession</a>
      
    </li>
  
  <li class="parent " data-id="cryomongo/Mongo/Session/ClusterTime" data-name="mongo::session::clustertime">
      <a href="Mongo/Session/ClusterTime.html">ClusterTime</a>
      
        <ul>
  
  <li class=" " data-id="cryomongo/Mongo/Session/ClusterTime/Signature" data-name="mongo::session::clustertime::signature">
      <a href="Mongo/Session/ClusterTime/Signature.html">Signature</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Session/Options" data-name="mongo::session::options">
      <a href="Mongo/Session/Options.html">Options</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Session/SessionId" data-name="mongo::session::sessionid">
      <a href="Mongo/Session/SessionId.html">SessionId</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Session/TransactionOptions" data-name="mongo::session::transactionoptions">
      <a href="Mongo/Session/TransactionOptions.html">TransactionOptions</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Session/TransactionState" data-name="mongo::session::transactionstate">
      <a href="Mongo/Session/TransactionState.html">TransactionState</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/Session/TransactionStateEvent" data-name="mongo::session::transactionstateevent">
      <a href="Mongo/Session/TransactionStateEvent.html">TransactionStateEvent</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/SRV" data-name="mongo::srv">
      <a href="Mongo/SRV.html">SRV</a>
      
    </li>
  
  <li class=" " data-id="cryomongo/Mongo/WriteConcern" data-name="mongo::writeconcern">
      <a href="Mongo/WriteConcern.html">WriteConcern</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<p>&lt;div align="center">
	&lt;img src="icon.svg" width="128" height="128" />
	&lt;h1>cryomongo&lt;/h1>
  &lt;h3>A MongoDB driver written in pure Crystal.&lt;/h3>
  &lt;a href="https://travis-ci.org/elbywan/cryomongo">&lt;img alt="travis-badge" src="https://travis-ci.org/elbywan/cryomongo.svg?branch=master">&lt;/a>
  &lt;a href="https://github.com/elbywan/cryomongo/tags">&lt;img alt="GitHub tag (latest SemVer)" src="https://img.shields.io/github/v/tag/elbywan/cryomongo">&lt;/a>
  &lt;a href="https://github.com/elbywan/cryomongo/blob/master/LICENSE">&lt;img alt="GitHub" src="https://img.shields.io/github/license/elbywan/cryomongo">&lt;/a>
&lt;/div></p>

<p>&lt;hr/></p>

<h4><a id="cryomongo-is-a-high-performance-mongo-db-driver-written-in-pure-crystal.-i.e.-no-c-dependencies-needed." class="anchor" href="#cryomongo-is-a-high-performance-mongo-db-driver-written-in-pure-crystal.-i.e.-no-c-dependencies-needed.">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Cryomongo is a high-performance MongoDB driver written in pure Crystal. (i.e. no C dependencies needed.)</h4>

<p><em>Compatible with MongoDB 3.6+. Tested against: 4.0 and 4.2.</em></p>

<p><strong>⚠️ BETA state.</strong></p>

<blockquote>If you are looking for a higher-level object-document mapper library, you might want to check out the <a href="https://github.com/elbywan/moongoon"><code>moongoon</code></a> shard.</blockquote>

<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>

<ol><li>Add the dependency to your <code>shard.yml</code>:</li></ol>

<pre><code class="language-yaml">dependencies:
  cryomongo:
    github: elbywan/cryomongo</code></pre>

<ol><li>Run <code>shards install</code></li></ol>

<h2><a id="usage" class="anchor" href="#usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Usage</h2>

<h3><a id="minimal-working-example" class="anchor" href="#minimal-working-example">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Minimal working example</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># Create a Mongo client, using a standard mongodb connection string.</span>
client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span> <span class="c"># defaults to: &quot;mongodb://localhost:27017&quot;</span>

<span class="c"># Get database and collection.</span>
database <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>]
collection <span class="o">=</span> database[<span class="s">&quot;collection_name&quot;</span>]

<span class="c"># Perform crud operations.</span>
collection.insert_one({ one: <span class="n">1</span> })
collection.replace_one({ one: <span class="n">1</span> }, { two: <span class="n">2</span> })
bson <span class="o">=</span> collection.find_one({ two: <span class="n">2</span> })
puts bson.not_nil!.[<span class="s">&quot;two&quot;</span>] <span class="c"># =&gt; 2</span>
collection.delete_one({ two: <span class="n">2</span> })
puts collection.count_documents <span class="c"># =&gt; 0</span></code></pre>

<h3><a id="complex-example-with-serialization" class="anchor" href="#complex-example-with-serialization">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Complex example with serialization</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># We take advantage of the BSON serialization capabilities provided by the `bson.cr` shard.</span>
record <span class="t">User</span>,
  name : <span class="t">String</span>,
  banned : <span class="t">Bool</span>? <span class="o">=</span> <span class="n">false</span>,
  _id : <span class="t">BSON</span><span class="t">::</span><span class="t">ObjectId</span> <span class="o">=</span> <span class="t">BSON</span><span class="t">::</span><span class="t">ObjectId</span>.<span class="k">new</span>,
  creation_date : <span class="t">Time</span> <span class="o">=</span> <span class="t">Time</span>.utc <span class="k">do</span>
  <span class="k">include</span> <span class="t">BSON</span><span class="t">::</span><span class="t">Serializable</span>
  <span class="k">include</span> <span class="t">JSON</span><span class="t">::</span><span class="t">Serializable</span>
<span class="k">end</span>

<span class="c"># Initialize Client, Database and Collection.</span>
client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>
database <span class="o">=</span> client[<span class="s">&quot;database&quot;</span>]
users <span class="o">=</span> database[<span class="s">&quot;users&quot;</span>]

<span class="c"># We set majority read and write at the Database level.</span>
database.read_concern <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">ReadConcern</span>.<span class="k">new</span>(level: <span class="s">&quot;majority&quot;</span>)
database.write_concern <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">WriteConcern</span>.<span class="k">new</span>(w: <span class="s">&quot;majority&quot;</span>)

<span class="c"># Drop and recreate the Collection to ensure that we read later only the documents we inserted in this example.</span>
{ <span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">Drop</span>, <span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">Create</span> }.each <span class="k">do</span> <span class="o">|</span>command<span class="o">|</span>
  database.command(command, name: <span class="s">&quot;users&quot;</span>)
<span class="k">rescue</span> e : <span class="t">Mongo</span><span class="t">::</span><span class="t">Error</span><span class="t">::</span><span class="t">Command</span>
  <span class="c"># ignore the server error, drop will fail if the collection has not been created before.</span>
<span class="k">end</span>

<span class="c"># Insert User structures that are automatically serialized to BSON.</span>
users.insert_many({ <span class="s">&quot;John&quot;</span>, <span class="s">&quot;Jane&quot;</span> }.map { <span class="o">|</span>name<span class="o">|</span>
  <span class="t">User</span>.<span class="k">new</span>(name: name)
}.to_a)

<span class="c"># Fetch a Cursor pointing to the users collection.</span>
cursor <span class="o">=</span> users.find

<span class="c"># Iterate the cursor and use `.of(User)` to deserialize as the cursor gets iterated.</span>
<span class="c"># Then push the users into an array that gets pretty printed.</span>
puts cursor.<span class="k">of</span>(<span class="t">User</span>).to_a.to_pretty_json
<span class="c"># =&gt; [</span>
<span class="c">#   {</span>
<span class="c">#     &quot;name&quot;: &quot;John&quot;,</span>
<span class="c">#     &quot;banned&quot;: false,</span>
<span class="c">#     &quot;_id&quot;: {</span>
<span class="c">#       &quot;$oid&quot;: &quot;f2001c5fb0a33e0264e2ea05&quot;</span>
<span class="c">#     },</span>
<span class="c">#     &quot;creation_date&quot;: &quot;2020-07-25T09:52:50Z&quot;</span>
<span class="c">#   },</span>
<span class="c">#   {</span>
<span class="c">#     &quot;name&quot;: &quot;Jane&quot;,</span>
<span class="c">#     &quot;banned&quot;: false,</span>
<span class="c">#     &quot;_id&quot;: {</span>
<span class="c">#       &quot;$oid&quot;: &quot;f2001c5fb0a33e0264e2ea07&quot;</span>
<span class="c">#     },</span>
<span class="c">#     &quot;creation_date&quot;: &quot;2020-07-25T09:52:50Z&quot;</span>
<span class="c">#   }</span>
<span class="c"># ]</span></code></pre>

<h2><a id="features" class="anchor" href="#features">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Features</h2>

<ul><li><strong><a href="https://docs.mongodb.com/manual/crud/index.html">CRUD operations</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/aggregation/">Aggregation</a> (except: Map-Reduce)</strong></li><li><strong><a href="https://docs.mongodb.com/manual/reference/method/Bulk/index.html">Bulk</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/reference/read-concern/index.html">Read</a> and <a href="https://docs.mongodb.com/manual/reference/write-concern/">Write</a> Concerns</strong></li><li><strong><a href="https://docs.mongodb.com/manual/core/read-preference/index.html">Read Preference</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/core/authentication/index.html">Authentication</a> (only: SCRAM mechanisms)</strong></li><li><strong><a href="https://docs.mongodb.com/manual/core/security-transport-encryption/">TLS encryption</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/indexes/index.html">Indexes</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/core/gridfs/index.html">GridFS</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/changeStreams/index.html">Change Streams</a></strong></li><li><strong><a href="https://elbywan.github.io/cryomongo/Mongo/Commands.html">Admin/Diagnostic commands</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/core/tailable-cursors/index.html">Tailable and Awaitable cursors</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/reference/collation/index.html">Collation</a></strong></li><li><strong>Standalone, <a href="https://docs.mongodb.com/manual/sharding/">Sharded</a> or <a href="https://docs.mongodb.com/manual/replication/">ReplicaSet</a> topologies</strong></li><li><strong><a href="https://github.com/mongodb/specifications/blob/master/source/command-monitoring/command-monitoring.rst">Command monitoring</a></strong></li><li><strong>Retryable <a href="https://docs.mongodb.com/manual/core/retryable-reads/">reads</a> and <a href="https://docs.mongodb.com/manual/core/retryable-writes/">writes</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/#client-sessions-and-causal-consistency-guarantees">Causal consistency</a></strong></li><li><strong><a href="https://docs.mongodb.com/manual/core/transactions/">Transactions</a></strong></li></ul>

<h2><a id="conventions" class="anchor" href="#conventions">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Conventions</h2>

<ul><li>Methods and arguments names are in <strong>snake case</strong>.</li><li>Object arguments can usually be passed as a <strong><a href="https://crystal-lang.org/api/NamedTuple.html">NamedTuple</a></strong>, <strong><a href="https://crystal-lang.org/api/Hash.html">Hash</a></strong>, <strong><a href="https://github.com/elbywan/bson.cr#serialization">BSON::Serializable</a></strong> or a <strong><a href="https://elbywan.github.io/bson.cr/BSON.html">BSON</a></strong> instance.</li></ul>

<h2><a id="documentation" class="anchor" href="#documentation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Documentation</h2>

<p><strong>The generated API documentation is available <a href="https://elbywan.github.io/cryomongo/Mongo.html">here</a>.</strong></p>

<h3><a id="connection" class="anchor" href="#connection">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Connection</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># Mongo::Client is the root object for interacting with a MongoDB deployment.</span>
<span class="c"># It is responsible for monitoring the cluster, routing the requests and managing the socket pools.</span>

<span class="c"># A client can be instantiated using a standard mongodb connection string.</span>

<span class="c"># Client options can be passed as query parameters…</span>
client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>(<span class="s">&quot;mongodb://address:port/database?appname=MyApp&quot;</span>)
<span class="c"># …or with a Mongo::Options instance…</span>
options <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Options</span>.<span class="k">new</span>(appname: <span class="s">&quot;MyApp&quot;</span>)
client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>(<span class="s">&quot;mongodb://address:port/database&quot;</span>, options)
<span class="c"># …or both.</span>

<span class="c"># Instantiate objects to interact with a specific database or a collection…</span>
database   <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>]
collection <span class="o">=</span> database[<span class="s">&quot;collection_name&quot;</span>]
<span class="c"># …or using `default_database` if the connection uri string contains a default auth database component (&quot;/database&quot;).</span>
database   <span class="o">=</span> client.default_database
collection <span class="o">=</span> database.not_nil!.collection[<span class="s">&quot;collection_name&quot;</span>]

<span class="c"># The overwhelming majority of programs should use a single client and should not bother with closing clients.</span>
<span class="c"># Otherwise, to free the underlying resources a client must be manually closed.</span>
client.close</code></pre>

<pre><code class="language-crystal"><span class="c"># To enable SSL/TLS, use the `tls` option, alongside the `tlsCAFile` and `tlsCertificateKeyFile` options.</span>
uri <span class="o">=</span> <span class="s">&quot;mongodb://localhost:27017/?tls=true&amp;tlsCAFile=./ca.crt&amp;tlsCertificateKeyFile=./client.pem&quot;</span>
ssl_client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span> uri</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Client.html">Mongo::Client</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Options.html">Mongo::Options</a></li></ul>

<h3><a id="authentication" class="anchor" href="#authentication">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Authentication</h3>

<p><em>Cryomongo only supports the SCRAM-SHA1 and SCRAM-SHA256 authentication methods without SASLprep.</em></p>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># To use authentication, specify a username and password when passing an URI to the client constructor.</span>
<span class="c"># Authentication methods depend on the server configuration and on the value of the `authMechanism` query parameter.</span>
client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>(<span class="s">&quot;mongodb://username:password@localhost:27017&quot;</span>)</code></pre>

<h3><a id="basic-operations" class="anchor" href="#basic-operations">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Basic operations</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>

<span class="c"># Most CRUD operations are performed at collection-level.</span>
collection <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>][<span class="s">&quot;collection_name&quot;</span>]

<span class="c"># The examples below are very basic, but the methods can accept all the options documented in the MongoDB manual.</span>

<span class="c">## Create</span>

<span class="c"># Insert a single document</span>
collection.insert_one({ key: <span class="s">&quot;value&quot;</span> })
<span class="c"># Insert multiple documents</span>
collection.insert_many((<span class="n">1</span>..<span class="n">100</span>).map{<span class="o">|</span>i<span class="o">|</span> { count: i }}.to_a)

<span class="c"># To track the _id, generate and pass it as a property</span>
id <span class="o">=</span> <span class="t">BSON</span><span class="t">::</span><span class="t">ObjectId</span>.<span class="k">new</span>
collection.insert_one({ _id: id, key: <span class="s">&quot;value&quot;</span> })

<span class="c">## Read</span>

<span class="c"># Find a single document</span>
document <span class="o">=</span> collection.find_one({ _id: id })
document.try { <span class="o">|</span>d<span class="o">|</span> puts d.to_json }
<span class="c"># Find multiple documents.</span>
cursor <span class="o">=</span> collection.find({ qty: { <span class="s">&quot;$gt&quot;</span>: <span class="n">4</span> }})
elements <span class="o">=</span> cursor.to_a <span class="c"># cursor is an Iterable(BSON)</span>

<span class="c">## Update</span>

<span class="c"># Replace a single document.</span>
collection.replace_one({ name: <span class="s">&quot;John&quot;</span> }, { name: <span class="s">&quot;Jane&quot;</span> })
<span class="c"># Update a single document.</span>
collection.update_one({ name: <span class="s">&quot;John&quot;</span> }, { <span class="s">&quot;$set&quot;</span>: { name: <span class="s">&quot;Jane&quot;</span> }})
<span class="c"># Update multiple documents</span>
collection.update_many({ name: { <span class="s">&quot;$in&quot;</span>: [<span class="s">&quot;John&quot;</span>, <span class="s">&quot;Jane&quot;</span>] }}, { <span class="s">&quot;$set&quot;</span>: { name: <span class="s">&quot;Jules&quot;</span> }})
<span class="c"># Find one document and replace it</span>
document <span class="o">=</span> collection.find_one_and_replace({ name: <span class="s">&quot;John&quot;</span> }, { name: <span class="s">&quot;Jane&quot;</span> })
puts document.try <span class="o">&amp;</span>.[<span class="s">&quot;name&quot;</span>]
<span class="c"># Find one document and update it</span>
document <span class="o">=</span> collection.find_one_and_update({ name: <span class="s">&quot;John&quot;</span> }, { <span class="s">&quot;$set&quot;</span>: { name: <span class="s">&quot;Jane&quot;</span> }})
puts document.try <span class="o">&amp;</span>.[<span class="s">&quot;name&quot;</span>]

<span class="c">## Delete</span>

<span class="c"># Delete one document</span>
collection.delete_one({ age: <span class="n">20</span> })
<span class="c"># Delete multiple documents</span>
collection.delete_many({ age: { <span class="s">&quot;$lt&quot;</span>: <span class="n">18</span> }})
<span class="c"># find_one_and_delete</span>
document <span class="o">=</span> collection.find_one_and_delete({ age: { <span class="s">&quot;$lt&quot;</span>: <span class="n">18</span> }})
puts document.try <span class="o">&amp;</span>.[<span class="s">&quot;age&quot;</span>]

<span class="c"># Aggregate</span>

<span class="c"># Perform an aggregation pipeline query</span>
cursor <span class="o">=</span> collection.aggregate([
  {<span class="s">&quot;$match&quot;</span>: { status: <span class="s">&quot;available&quot;</span> }}
  {<span class="s">&quot;$limit&quot;</span>: <span class="n">5</span>},
])
cursor.try <span class="o">&amp;</span>.each { <span class="o">|</span>bson<span class="o">|</span> puts bson.to_json }

<span class="c"># Distinct collection values</span>
values <span class="o">=</span> collection.distinct(
  key: <span class="s">&quot;field&quot;</span>,
  filter: { age: { <span class="s">&quot;$gt&quot;</span>: <span class="n">18</span> }}
)

<span class="c"># Documents count</span>
counter <span class="o">=</span> collection.count_documents({ age: { <span class="s">&quot;$lt&quot;</span>: <span class="n">18</span> }})

<span class="c"># Estimated count</span>
counter <span class="o">=</span> collection.estimated_document_count</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Collection.html">Mongo::Collection</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Database.html">Mongo::Database</a></li></ul>

<h3><a id="bulk-operations" class="anchor" href="#bulk-operations">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Bulk operations</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>

<span class="c"># A Bulk object can be initialized by calling `.bulk` on a collection.</span>
collection <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>][<span class="s">&quot;collection_name&quot;</span>]
bulk <span class="o">=</span> collection.bulk
<span class="c"># A bulk is ordered by default.</span>
bulk.ordered? <span class="c"># =&gt; true</span>

<span class="n">500</span>.times { <span class="o">|</span>idx<span class="o">|</span>
  <span class="c"># Build the queries by calling bulk methods multiple times.</span>
  bulk.insert_one({number: idx})
  bulk.delete_many({number: {<span class="s">&quot;$lt&quot;</span>: <span class="n">450</span>}})
  bulk.replace_one({ number: idx }, { number: idx <span class="o">+</span> <span class="n">1</span>})
}

<span class="c"># Execute all the queries and return an aggregated result.</span>
pp bulk.execute(write_concern: <span class="t">Mongo</span><span class="t">::</span><span class="t">WriteConcern</span>.<span class="k">new</span>(w: <span class="n">1</span>))</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Bulk.html">Mongo::Bulk</a></li></ul>

<h3><a id="indexes" class="anchor" href="#indexes">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Indexes</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>
collection <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>][<span class="s">&quot;collection_name&quot;</span>]

<span class="c"># Create one index without options…</span>
collection.create_index(
  keys: {
    <span class="s">&quot;a&quot;</span>:  <span class="n">1</span>,
    <span class="s">&quot;b&quot;</span>:  <span class="n">-1</span>,
  }
)
<span class="c"># or with options (snake_cased)…</span>
collection.create_index(
  keys: {
    <span class="s">&quot;a&quot;</span>:  <span class="n">1</span>,
    <span class="s">&quot;b&quot;</span>:  <span class="n">-1</span>,
  },
  options: {
    unique: <span class="n">true</span>
  }
)
<span class="c"># and optionally specify the name.</span>
collection.create_index(
  keys: {
    <span class="s">&quot;a&quot;</span>:  <span class="n">1</span>,
    <span class="s">&quot;b&quot;</span>:  <span class="n">-1</span>,
  },
  options: {
    name: <span class="s">&quot;index_name&quot;</span>,
  }
)

<span class="c"># Follow the same rules to create multiple indexes with a single method call.</span>
collection.create_indexes([
  {
    keys: { a: <span class="n">1</span> }
  },
  {
    keys: { b: <span class="n">2</span> }, options: { expire_after_seconds: <span class="n">3600</span> }
  }
])</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Collection.html">Mongo::Collection</a></li></ul>

<h3><a id="grid-fs" class="anchor" href="#grid-fs">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>GridFS</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>
database <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>]

<span class="c"># A GridFS bucket belong to a database.</span>
gridfs <span class="o">=</span> database.grid_fs

<span class="c"># Upload</span>
file <span class="o">=</span> <span class="t">File</span>.<span class="k">new</span>(<span class="s">&quot;file.txt&quot;</span>)
id <span class="o">=</span> gridfs.upload_from_stream(<span class="s">&quot;file.txt&quot;</span>, file)
file.close

<span class="c"># Download</span>
stream <span class="o">=</span> <span class="t">IO</span><span class="t">::</span><span class="t">Memory</span>.<span class="k">new</span>
gridfs.download_to_stream(id, stream)
puts stream.rewind.gets_to_end

<span class="c"># Find</span>
files <span class="o">=</span> gridfs.find({
  length: {<span class="s">&quot;$gte&quot;</span>: <span class="n">5000</span>},
})
files.each { <span class="o">|</span>file<span class="o">|</span>
  puts file.filename
}

<span class="c"># Delete</span>
gridfs.delete(id)

<span class="c"># And many more methods… (check the link below.)</span></code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/GridFS/Bucket.html">Mongo::GridFS::Bucket</a></li></ul>

<h3><a id="change-streams" class="anchor" href="#change-streams">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Change streams</h3>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># Change streams can watch a client, database or collection for change.</span>
<span class="c"># This code snippet will focus on watching a single collection.</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>
collection <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>][<span class="s">&quot;collection_name&quot;</span>]

spawn {
  cursor <span class="o">=</span> collection.watch(
    [
      {<span class="s">&quot;$match&quot;</span>: {<span class="s">&quot;operationType&quot;</span>: <span class="s">&quot;insert&quot;</span>}},
    ],
    max_await_time_ms: <span class="n">10000</span>
  )
  <span class="c"># cursor.of(BSON) converts fetched elements to the Mongo::ChangeStream::Document(BSON) type.</span>
  cursor.<span class="k">of</span>(<span class="t">BSON</span>).each { <span class="o">|</span>doc<span class="o">|</span>
    puts doc.document_key
    puts doc.full_document.to_json
  }
}

<span class="n">100</span>.times <span class="k">do</span> <span class="o">|</span>i<span class="o">|</span>
  collection.insert_one({count: i})
<span class="k">end</span>

sleep</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/ChangeStream/Cursor.html">Mongo::ChangeStream::Cursor</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/ChangeStream/Document.html">Mongo::ChangeStream::Document</a></li></ul>

<h2><a id="raw-commands" class="anchor" href="#raw-commands">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Raw commands</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># Commands can be run on a client, database or collection depending on the command target.</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>

<span class="c"># Call the `.command` method to run a command against the server.</span>
<span class="c"># The first argument is a `Mongo::Commands` sub-class, followed by the mandatory arguments</span>
<span class="c"># and finally an *options* named tuple containing the optional parameters in snake_case.</span>
result <span class="o">=</span> client.command(<span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">ServerStatus</span>, options: {
  repl: <span class="n">0</span>
})
puts result.to_bson

<span class="c"># The .command method can also be called against a Database…</span>
client[<span class="s">&quot;database&quot;</span>].command(<span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">Create</span>, name: <span class="s">&quot;collection&quot;</span>)
client[<span class="s">&quot;database&quot;</span>].command(<span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">Drop</span>, name: <span class="s">&quot;collection&quot;</span>)
<span class="c"># …or a Collection.</span>
client[<span class="s">&quot;database&quot;</span>][<span class="s">&quot;collection&quot;</span>].command(<span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">Validate</span>)</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Commands.html">Mongo::Commands</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Client.html#command(command,write_concern:WriteConcern?=nil,read_concern:ReadConcern?=nil,read_preference:ReadPreference?=nil,server_description:SDAM::ServerDescription?=nil,session:Session::ClientSession?=nil,operation_id:Int64?=nil,**args">Mongo::Client#command</a>-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Database.html#command(operation,write_concern:WriteConcern?=nil,read_concern:ReadConcern?=nil,read_preference:ReadPreference?=nil,session:Session::ClientSession?=nil,**args">Mongo::Database#command</a>-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Collection.html#command(operation,write_concern:WriteConcern?=nil,read_concern:ReadConcern?=nil,read_preference:ReadPreference?=nil,session:Session::ClientSession?=nil,**args">Mongo::Collection#command</a>-instance-method)</li></ul>

<h2><a id="concerns-and-preference" class="anchor" href="#concerns-and-preference">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Concerns and Preference</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># Instantiate Read/Write Concerns and Preference</span>
read_concern <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">ReadConcern</span>.<span class="k">new</span>(level: <span class="s">&quot;majority&quot;</span>)
write_concern <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">WriteConcern</span>.<span class="k">new</span>(w: <span class="n">1</span>, j: <span class="n">true</span>)
read_preference <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">ReadPreference</span>.<span class="k">new</span>(mode: <span class="s">&quot;primary&quot;</span>)

<span class="c"># They can be set at the client, database or client level…</span>
client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>
database <span class="o">=</span> client[<span class="s">&quot;database_name&quot;</span>]
collection <span class="o">=</span> database[<span class="s">&quot;collection_name&quot;</span>]

client.read_concern <span class="o">=</span> read_concern
database.write_concern <span class="o">=</span> write_concern
collection.read_preference <span class="o">=</span> read_preference

<span class="c"># …or by passing an extra argument when calling a method.</span>
collection.find(
  filter: { key: <span class="s">&quot;value&quot;</span> },
  read_concern:  <span class="t">Mongo</span><span class="t">::</span><span class="t">ReadConcern</span>.<span class="k">new</span>(level: <span class="s">&quot;local&quot;</span>),
  read_preference: <span class="t">Mongo</span><span class="t">::</span><span class="t">ReadPreference</span>.<span class="k">new</span>(mode: <span class="s">&quot;secondary&quot;</span>)
)</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/ReadConcern.html">Mongo::ReadConcern</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/WriteConcern.html">Mongo::WriteConcern</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/ReadPreference.html">Mongo::ReadPreference</a></li></ul>

<h2><a id="commands-monitoring" class="anchor" href="#commands-monitoring">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Commands Monitoring</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>

<span class="c"># A simple logging subscriber.</span>

subscription <span class="o">=</span> client.subscribe_commands { <span class="o">|</span>event<span class="o">|</span>
  <span class="k">case</span> event
  <span class="k">when</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Monitoring</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">CommandStartedEvent</span>
    <span class="t">Log</span>.info { <span class="s">&quot;COMMAND.</span><span class="i">#{</span>event.command_name<span class="i">}</span><span class="s"> </span><span class="i">#{</span>event.address<span class="i">}</span><span class="s"> STARTED: </span><span class="i">#{</span>event.command.to_json<span class="i">}</span><span class="s">&quot;</span> }
  <span class="k">when</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Monitoring</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">CommandSucceededEvent</span>
    <span class="t">Log</span>.info { <span class="s">&quot;COMMAND.</span><span class="i">#{</span>event.command_name<span class="i">}</span><span class="s"> </span><span class="i">#{</span>event.address<span class="i">}</span><span class="s"> COMPLETED: </span><span class="i">#{</span>event.reply.to_json<span class="i">}</span><span class="s"> (</span><span class="i">#{</span>event.duration<span class="i">}</span><span class="s">s)&quot;</span> }
  <span class="k">when</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Monitoring</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">CommandFailedEvent</span>
    <span class="t">Log</span>.info { <span class="s">&quot;COMMAND.</span><span class="i">#{</span>event.command_name<span class="i">}</span><span class="s"> </span><span class="i">#{</span>event.address<span class="i">}</span><span class="s"> FAILED: </span><span class="i">#{</span>event.failure.inspect<span class="i">}</span><span class="s"> (</span><span class="i">#{</span>event.duration<span class="i">}</span><span class="s">s)&quot;</span> }
  <span class="k">end</span>
}

<span class="c"># Make some queries…</span>
client[<span class="s">&quot;database_name&quot;</span>][<span class="s">&quot;collection_name&quot;</span>].find({ hello: <span class="s">&quot;world&quot;</span> })

<span class="c"># …and eventually at some point, unsubscribe the logger.</span>
client.unsubscribe_commands(subscription)</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Client.html#subscribe_commands(&callback:Monitoring::Commands::Event->Nil">Mongo::Client#subscribe_commands</a>:Monitoring::Commands::Event->Nil-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Client.html#unsubscribe_commands(callback:Monitoring::Commands::Event->Nil">Mongo::Client#unsubscribe_commands</a>:Nil-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Monitoring/Observable.html">Mongo::Monitoring::Observable</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Monitoring/Commands/CommandStartedEvent.html">Mongo::Monitoring::CommandStartedEvent</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Monitoring/Commands/CommandSucceededEvent.html">Mongo::Monitoring::CommandSucceededEvent</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Monitoring/Commands/CommandFailedEvent.html">Mongo::Monitoring::CommandFailedEvent</a></li></ul>

<h2><a id="causal-consistency" class="anchor" href="#causal-consistency">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Causal Consistency</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>
<span class="c"># It is important to ensure that both read and writes are performed with &quot;majority&quot; concern.</span>
<span class="c"># See: https://docs.mongodb.com/manual/core/causal-consistency-read-write-concerns/</span>
client.read_concern <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">ReadConcern</span>.<span class="k">new</span>(level: <span class="s">&quot;majority&quot;</span>)
client.write_concern <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">WriteConcern</span>.<span class="k">new</span>(w: <span class="s">&quot;majority&quot;</span>)

<span class="c"># Reusing the original Mongodb example.</span>
<span class="c"># See: https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/#examples</span>

current_date <span class="o">=</span> <span class="t">Time</span>.utc
items <span class="o">=</span> client[<span class="s">&quot;test&quot;</span>][<span class="s">&quot;items&quot;</span>]

<span class="c"># MongoDB enables causal consistency in client sessions by default.</span>
<span class="c"># This is the block syntax that creates, ends and pass the session to collection methods automatically.</span>
items_collection.with_session <span class="k">do</span> <span class="o">|</span>items<span class="o">|</span>
  <span class="c"># Using a causally consistent session ensures that the update occurs before the insert.</span>
  items.update_one(
    { sku: <span class="s">&quot;111&quot;</span>, <span class="k">end</span>: { <span class="s">&quot;$exists&quot;</span>: <span class="n">false</span> } },
    { <span class="s">&quot;$set&quot;</span>: { <span class="k">end</span>: current_date }}
  )
  items.insert_one({ sku: <span class="s">&quot;nuts-111&quot;</span>, name: <span class="s">&quot;Pecans&quot;</span>, start: current_date })
  puts items.find.to_a.to_pretty_json
<span class="k">end</span>

client.close</code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Session.html">Mongo::Session</a></li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Client.html#start_session(*,causal_consistency:Bool=true">Mongo::Client#start_session</a>:Session::ClientSession-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Collection.html#with_session(**args,&">Mongo::Collection#with_session</a>-instance-method)</li></ul>

<h2><a id="transactions" class="anchor" href="#transactions">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Transactions</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;cryomongo&quot;</span>

<span class="c"># Initialize Client and Database instances.</span>
client <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>
database <span class="o">=</span> client[<span class="s">&quot;db&quot;</span>]
collection <span class="o">=</span> database[<span class="s">&quot;collection&quot;</span>]

<span class="c"># Create the collection.</span>
{<span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">Drop</span>, <span class="t">Mongo</span><span class="t">::</span><span class="t">Commands</span><span class="t">::</span><span class="t">Create</span>}.each <span class="k">do</span> <span class="o">|</span>command<span class="o">|</span>
  database.command(command, name: <span class="s">&quot;collection&quot;</span>)
<span class="k">rescue</span> e : <span class="t">Mongo</span><span class="t">::</span><span class="t">Error</span><span class="t">::</span><span class="t">Command</span>
  <span class="c"># ignore the server error, drop will fail if the collection has not been created before.</span>
<span class="k">end</span>

<span class="c"># Set read and write concerns to perform isolated transactions.</span>
<span class="c"># See: https://docs.mongodb.com/master/core/transactions/#transactions-and-sessions</span>
transaction_options <span class="o">=</span> <span class="t">Mongo</span><span class="t">::</span><span class="t">Session</span><span class="t">::</span><span class="t">TransactionOptions</span>.<span class="k">new</span>(
  read_concern: <span class="t">Mongo</span><span class="t">::</span><span class="t">ReadConcern</span>.<span class="k">new</span>(level: <span class="s">&quot;snapshot&quot;</span>),
  write_concern: <span class="t">Mongo</span><span class="t">::</span><span class="t">WriteConcern</span>.<span class="k">new</span>(w: <span class="s">&quot;majority&quot;</span>)
)

<span class="c"># There are two ways to perform transactions:</span>

collection.with_session(default_transaction_options: transaction_options) <span class="k">do</span> <span class="o">|</span>collection, session<span class="o">|</span>
  puts collection.find.to_a.to_json <span class="c"># =&gt; &quot;[]&quot;</span>

  <span class="c"># 1. by calling the `with_transaction` method.</span>

  <span class="c"># `with_transaction` will commit after the block ends.</span>
  <span class="c"># if the block raises, the transaction will be aborted.</span>
  session.with_transaction {
    collection.insert_one({_id: <span class="n">1</span>})
    collection.insert_one({_id: <span class="n">2</span>})
  }
  puts collection.find.to_a.to_json <span class="c"># =&gt; [{&quot;_id&quot;:1},{&quot;_id&quot;:2}]</span>

  <span class="c"># The transaction below will be aborted because the block raises an Exception.</span>
  <span class="k">begin</span>
    session.with_transaction {
      collection.insert_one({_id: <span class="n">3</span>})
      raise <span class="s">&quot;Interrupted!&quot;</span>
      collection.insert_one({_id: <span class="n">4</span>})
    }
  <span class="k">rescue</span> e
    puts e <span class="c"># =&gt; Interrupted!</span>
  <span class="k">end</span>
  puts collection.find.to_a.to_json <span class="c"># =&gt; [{&quot;_id&quot;:1},{&quot;_id&quot;:2}]</span>

  <span class="c"># 2. by calling the `start_transaction`, `commit_transaction` and `abort_transaction` methods.</span>
  session.start_transaction
  collection.insert_one({_id: <span class="n">3</span>})
  <span class="c"># The transaction is isolated, reading outside of the session scope does not return documents impacted by the transaction…</span>
  puts database[<span class="s">&quot;collection&quot;</span>].find.to_a.to_json <span class="c"># =&gt; [{&quot;_id&quot;:1},{&quot;_id&quot;:2}]</span>
  <span class="c"># but reading within the session scope does.</span>
  puts collection.find.to_a.to_json <span class="c"># =&gt; [{&quot;_id&quot;:1},{&quot;_id&quot;:2},{&quot;_id&quot;:3}]</span>
  session.commit_transaction
  <span class="c"># The transaction is now committed and visible outside of the transaction scope.</span>
  puts collection.find.to_a.to_json             <span class="c"># =&gt; [{&quot;_id&quot;:1},{&quot;_id&quot;:2},{&quot;_id&quot;:3}]</span>
  puts database[<span class="s">&quot;collection&quot;</span>].find.to_a.to_json <span class="c"># =&gt; [{&quot;_id&quot;:1},{&quot;_id&quot;:2},{&quot;_id&quot;:3}]</span>
<span class="k">end</span></code></pre>

<p><strong>Links</strong></p>

<ul><li><a href="https://elbywan.github.io/cryomongo/Mongo/Session/ClientSession.html#with_transaction(**options,&">Mongo::Session#with_transaction</a>-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Session/ClientSession.html#start_transaction(**options">Mongo::Session#start_transaction</a>-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Session/ClientSession.html#commit_transaction(*,write_concern:WriteConcern?=nil">Mongo::Session#commit_transaction</a>-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Session/ClientSession.html#abort_transaction(*,write_concern:WriteConcern?=nil">Mongo::Session#abort_transaction</a>-instance-method)</li><li><a href="https://elbywan.github.io/cryomongo/Mongo/Session/TransactionOptions.html">Mongo::Session::TransactionOptions</a></li></ul>

<h2><a id="specifications" class="anchor" href="#specifications">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Specifications</h2>

<p>The goal is to to be compliant with most of the <a href="https://github.com/mongodb/specifications">official MongoDB set of specifications</a>.</p>

<p><strong>✅ Implemented</strong></p>

<p>The following specifications are implemented:</p>

<ul><li>https://github.com/mongodb/specifications/tree/master/source/message</li><li>https://github.com/mongodb/specifications/tree/master/source/crud</li><li>https://github.com/mongodb/specifications/blob/master/source/find_getmore_killcursors_commands.rst</li><li>https://github.com/mongodb/specifications/blob/master/source/driver-bulk-update.rst</li><li>https://github.com/mongodb/specifications/blob/master/source/read-write-concern/read-write-concern.rst</li><li>https://github.com/mongodb/specifications/blob/master/source/enumerate-collections.rst</li><li>https://github.com/mongodb/specifications/blob/master/source/enumerate-databases.rst</li><li>https://github.com/mongodb/specifications/blob/master/source/enumerate-indexes.rst</li><li>https://github.com/mongodb/specifications/tree/master/source/connection-string</li><li>https://github.com/mongodb/specifications/tree/master/source/uri-options (except validation)</li><li>https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring</li><li>https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.rst</li><li>https://github.com/mongodb/specifications/blob/master/source/max-staleness/max-staleness.rst</li><li>https://github.com/mongodb/specifications/tree/master/source/connection-monitoring-and-pooling (loosely - using the crystal-db pool)</li><li>https://github.com/mongodb/specifications/blob/master/source/auth/auth.rst (SHA1 / SHA256 only - without SASLprep)</li><li>https://github.com/mongodb/specifications/blob/master/source/index-management.rst (no IndexView fluid syntax)</li><li>https://github.com/mongodb/specifications/tree/master/source/gridfs</li><li>https://github.com/mongodb/specifications/tree/master/source/change-streams</li><li>https://github.com/mongodb/specifications/blob/master/source/sessions/driver-sessions.rst</li><li>https://github.com/mongodb/specifications/tree/master/source/command-monitoring</li><li>https://github.com/mongodb/specifications/blob/master/source/retryable-writes/retryable-writes.rst</li><li>https://github.com/mongodb/specifications/blob/master/source/retryable-reads/retryable-reads.rst</li><li>https://github.com/mongodb/specifications/tree/master/source/causal-consistency</li><li>https://github.com/mongodb/specifications/blob/master/source/initial-dns-seedlist-discovery</li><li>https://github.com/mongodb/specifications/tree/master/source/transactions</li></ul>

<p><strong>⏳Next</strong></p>

<p>The following specifications are to be implemented next:</p>

<ul><li>https://github.com/mongodb/specifications/blob/master/source/polling-srv-records-for-mongos-discovery</li><li>https://github.com/mongodb/specifications/tree/master/source/compression</li></ul>

<h2><a id="contributing" class="anchor" href="#contributing">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributing</h2>

<ol><li>Fork it (&lt;https://github.com/elbywan/cryomongo/fork>)</li><li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li><li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li><li>Push to the branch (<code>git push origin my-new-feature</code>)</li><li>Create a new Pull Request</li></ol>

<h2><a id="contributors" class="anchor" href="#contributors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributors</h2>

<ul><li><a href="https://github.com/elbywan">elbywan</a> - creator and maintainer</li></ul>

<h2><a id="credit" class="anchor" href="#credit">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Credit</h2>

<ul><li>Icon made by <a href="https://www.flaticon.com/authors/smashicons">Smashicons</a> from <a href="https://www.flaticon.com">www.flaticon.com</a>.</li></ul>
</div>
</body>
</html>
